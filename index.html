<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åå°ç¨‹å¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ç°¡å–®çš„è¦–è¦ºç¾åŒ– */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; }
        .field { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #00b900; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { background-color: #ccc; }
    </style>
</head>
<body>

<div class="card">
    <h2>æ´»å‹•å ±å</h2>
    <form id="regForm">
        <div class="field">
            <label>é¸æ“‡æ´»å‹•ï¼š</label>
            <select id="eventList" required>
                <option value="">è¼‰å…¥æ´»å‹•ä¸­...</option>
            </select>
        </div>
        <div class="field">
            <label>æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="userName" readonly placeholder="ç™»å…¥ LINE å¾Œè‡ªå‹•å¸¶å…¥">
        </div>
        <div class="field">
            <label>è¯çµ¡é›»è©±ï¼š</label>
            <input type="tel" id="userPhone" required placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
        </div>
        <div class="field">
            <label>å‚™è¨»ï¼š</label>
            <textarea id="userNote" rows="3"></textarea>
        </div>
        <button type="submit" id="submitBtn">æäº¤å ±å</button>
    </form>
</div>

<script>
    // é€™è£¡å¡«å…¥ä½ å‰›å‰›éƒ¨ç½²å¥½çš„ Google Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec";
    
    // é€™è£¡æš«æ™‚ç•™ç©ºï¼Œä¸‹ä¸€æ­¥å» LINE Developer ç”³è«‹å¾Œå¡«å…¥
    const MY_LIFF_ID = "å…ˆç•™ç©ºï¼Œç­‰ä¸€ä¸‹å¡«å…¥"; 

    async function init() {
        try {
            // åˆå§‹åŒ– LINE LIFF
            await liff.init({ liffId: MY_LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                liff.login(); // å¼•å°ä½¿ç”¨è€…ç™»å…¥ LINE
            } else {
                const profile = await liff.getProfile();
                document.getElementById('userName').value = profile.displayName;
                fetchEvents(); // ç™»å…¥æˆåŠŸå¾Œé–‹å§‹æŠ“å–æ´»å‹•æ¸…å–®
            }
        } catch (err) {
            console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err);
        }
    }

    // å‘ Google è©¦ç®—è¡¨è¦æ±‚ã€Œæ´»å‹•æ¸…å–®ã€
    async function fetchEvents() {
        const response = await fetch(API_URL);
        const data = await response.json();
        const select = document.getElementById('eventList');
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ´»å‹• --</option>';
        
        // å¾ç¬¬äºŒåˆ—é–‹å§‹å·¡è¿´ï¼ˆè·³éæ¨™é¡Œï¼‰
        for(let i=1; i<data.length; i++) {
            if(data[i][1] === "é€²è¡Œä¸­") { // åªé¡¯ç¤ºç‹€æ…‹ç‚ºé€²è¡Œä¸­çš„æ´»å‹•
                let opt = document.createElement('option');
                opt.value = data[i][0];
                opt.innerText = data[i][0];
                select.appendChild(opt);
            }
        }
    }

    // è™•ç†è¡¨å–®æäº¤
    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerText = "å‚³é€ä¸­...";

        const payload = {
            event: document.getElementById('eventList').value,
            name: document.getElementById('userName').value,
            phone: document.getElementById('userPhone').value,
            note: document.getElementById('userNote').value
        };

        // å°‡è³‡æ–™ POST åˆ° Google è©¦ç®—è¡¨
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        // åœ¨ LINE è¦–çª—ç™¼é€ä¸€æ¢è¨Šæ¯è®“å¤§å®¶çœ‹åˆ°
        await liff.sendMessages([{
            type: 'text',
            text: `ğŸ“¢ å ±åæˆåŠŸï¼\næ´»å‹•ï¼š${payload.event}\nå ±åè€…ï¼š${payload.name}`
        }]);

        alert("å ±åæˆåŠŸï¼");
        liff.closeWindow(); // é—œé–‰å°ç¨‹å¼è¦–çª—
    };

    init();
</script>
</body>
</html>
