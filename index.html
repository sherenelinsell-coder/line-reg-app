<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        .field { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #00b900; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        #eventDetail { background: #eef9ee; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 5px; display: none; white-space: pre-wrap; }
        #successUI { display: none; text-align: center; }
    </style>
</head>
<body>
<div class="card" id="formUI">
    <h2>活動報名</h2>
    <form id="regForm">
        <div class="field">
            <label>活動：</label>
            <select id="eventList" required onchange="showDetail()"><option value="">載入中...</option></select>
            <div id="eventDetail"></div>
        </div>
        <div class="field">
            <label>姓名：</label>
            <input type="text" id="userName" required>
        </div>
        <div class="field">
            <label>人數：</label>
            <input type="number" id="userCount" value="1" min="1" required>
        </div>
        <div class="field">
            <label>備註 (如：曲目)：</label>
            <textarea id="userNote" rows="2"></textarea>
        </div>
        <button type="submit" id="btn">送出報名</button>
    </form>
</div>

<div class="card" id="successUI">
    <h2 style="color:#00b900;">✅ 報名成功</h2>
    <div id="resInfo" style="text-align:left; font-size:14px; background:#f9f9f9; padding:10px;"></div>
    <button onclick="liff.closeWindow()" style="margin-top:10px;">關閉視窗</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec"; 
    const MY_LIFF_ID = "2008808495-Sbl6oi6u";
    let allEv = [];

    async function init() {
        await liff.init({ liffId: MY_LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        
        const savedName = localStorage.getItem('user_real_name');
        if(savedName) document.getElementById('userName').value = savedName;

        const res = await fetch(API_URL + "?action=getEvents");
        allEv = await res.json();
        const sel = document.getElementById('eventList');
        sel.innerHTML = '<option value="">-- 請選擇 --</option>';
        for(let i=1; i<allEv.length; i++) {
            if(allEv[i][1]==="進行中") sel.innerHTML += `<option value="${i}">${allEv[i][0]}</option>`;
        }
    }

    function showDetail() {
        const idx = document.getElementById('eventList').value;
        const box = document.getElementById('eventDetail');
        if(idx && allEv[idx][2]) { box.innerText = allEv[idx][2]; box.style.display="block"; }
        else box.style.display="none";
    }

    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn');
        btn.disabled = true; btn.innerText = "傳送中...";
        
        const idx = document.getElementById('eventList').value;
        const name = document.getElementById('userName').value;
        localStorage.setItem('user_real_name', name);
        const profile = await liff.getProfile();

        const data = {
            action: "register",
            event: allEv[idx][0],
            name: name,
            count: document.getElementById('userCount').value,
            note: document.getElementById('userNote').value,
            lineId: profile.userId
        };

        await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        
        document.getElementById('resInfo').innerHTML = `<b>活動：</b>${data.event}<br><b>詳情：</b>${allEv[idx][2] || '無'}<br><b>姓名：</b>${name}<br><b>備註：</b>${data.note}`;
        document.getElementById('formUI').style.display="none";
        document.getElementById('successUI').style.display="block";
        
        liff.sendMessages([{type:'text', text:`✅ 報名成功：${data.event}\n姓名：${name}`}]);
    };
    init();
</script>
</body>
</html>
