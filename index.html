<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å…¥å£</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 10px; border: none; border-radius: 5px; color: white; font-weight: bold; width: 48%; cursor: pointer; }
        .btn-reg { background: #00b900; }
        .btn-info { background: #3498db; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="listUI">
    <h2 style="text-align:center;">ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
    <div id="items">æ­£åœ¨è®€å–æœ€æ–°æ´»å‹•...</div>
</div>

<div id="regUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="regTitle">å ±åæ´»å‹•</h2>
    <input type="text" id="uName" placeholder="æ‚¨çš„å§“å" required>
    <input type="number" id="uCount" value="1" min="1" required>
    <textarea id="uNote" placeholder="å‚™è¨» (å¦‚ï¼šæ›²ç›®)"></textarea>
    <button onclick="submitReg()" class="btn-reg" style="width:100%; padding:15px;">ç¢ºèªæäº¤</button>
</div>

<div id="infoUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="infoTitle">å ±åç‹€æ³</h2>
    <div id="infoBox" style="background:#f9f9f9; padding:15px; border-radius:8px;"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec";
    const LIFF_ID = "2008808495-Sbl6oi6u";
    let curName = "";

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) { liff.login(); return; }
        
        try {
            const res = await fetch(API_URL + "?action=getEvents&t=" + Date.now());
            const data = await res.json();
            let html = "";
            for(let i=1; i<data.length; i++) {
                if(data[i][1] === "é€²è¡Œä¸­") {
                    html += `<div class="card">
                        <div style="font-size:18px; font-weight:bold; color:#00b900;">${data[i][0]}</div>
                        <p style="font-size:14px; color:#666;">${data[i][2] || 'ç„¡èªªæ˜'}</p>
                        <button class="btn btn-reg" onclick="openReg('${data[i][0]}')">æˆ‘è¦å ±å</button>
                        <button class="btn btn-info" onclick="openInfo('${data[i][0]}','${data[i][2]}')">å ±åç‹€æ³</button>
                    </div>`;
                }
            }
            document.getElementById('items').innerHTML = html || "æš«ç„¡æ´»å‹•";
        } catch(e) { document.getElementById('items').innerHTML = "é€£ç·šå¤±æ•—"; }
    }

    function openReg(name) {
        curName = name;
        document.getElementById('listUI').style.display = "none";
        document.getElementById('regUI').style.display = "block";
        document.getElementById('regTitle').innerText = name;
        document.getElementById('uName').value = localStorage.getItem('uName') || "";
    }

    async function openInfo(name, detail) {
        document.getElementById('listUI').style.display = "none";
        document.getElementById('infoUI').style.display = "block";
        document.getElementById('infoTitle').innerText = name;
        
        const res = await fetch(API_URL + "?action=getRecords&t=" + Date.now());
        const data = await res.json();
        let html = `ğŸ“Œ è©³æƒ…ï¼š${detail}<br><br><b>å ±ååå–®ï¼š</b><br>`;
        let count = 0;
        for(let i=1; i<data.length; i++) {
            if(data[i][1] === name) {
                count++;
                html += `${count}. ${data[i][2]} (${data[i][3]}äºº)<br>`;
            }
        }
        document.getElementById('infoBox').innerHTML = html + `<br><b>ç¸½è¨ˆï¼š${count} ç­†</b>`;
    }

    async function submitReg() {
        const name = document.getElementById('uName').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        localStorage.setItem('uName', name);
        const profile = await liff.getProfile();
        
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "register", event: curName, name: name, 
                count: document.getElementById('uCount').value,
                note: document.getElementById('uNote').value,
                lineId: profile.userId
            })
        });
        alert("å ±åæˆåŠŸï¼");
        location.reload();
    }
    init();
</script>
</body>
</html>
