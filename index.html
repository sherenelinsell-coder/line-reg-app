<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å…¥å£</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ev-title { color: #00b900; font-size: 18px; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex:1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-reg { background: #00b900; }
        .btn-info { background: #3498db; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="mainUI">
    <h2 style="text-align:center;">ğŸ“… ç›®å‰æ´»å‹•åˆ—è¡¨</h2>
    <div id="list">æ­£åœ¨è®€å–æœ€æ–°æ´»å‹•...</div>
</div>

<div id="regUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="regTitle">å ±å</h2>
    <input type="text" id="uName" placeholder="å§“å" required>
    <input type="number" id="uCount" value="1" min="1" required>
    <textarea id="uNote" placeholder="å‚™è¨»/æ›²ç›®"></textarea>
    <button onclick="submitReg()" class="btn-reg" style="width:100%; padding:15px; border:none; border-radius:8px; color:white; cursor:pointer;">ç¢ºèªæäº¤</button>
</div>

<div id="infoUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="infoTitle">å ±åç‹€æ³</h2>
    <div id="viewDetail" style="background:#eee; padding:10px; border-radius:5px; white-space:pre-wrap; font-size:14px;"></div>
    <div id="viewStatus" style="margin-top:20px;">æ­£åœ¨è®€å–åå–®...</div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec";
    const LIFF_ID = "2008808495-Sbl6oi6u";
    let curEv = "";

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        
        try {
            const res = await fetch(API_URL + "?action=getEvents&t=" + Date.now());
            const evs = await res.json();
            let html = "";
            for(let i=1; i<evs.length; i++){
                if(evs[i][1] === "é€²è¡Œä¸­"){
                    html += `<div class="card">
                        <div class="ev-title">${evs[i][0]}</div>
                        <p style="font-size:14px; color:#666;">${evs[i][2] || 'ç„¡èªªæ˜'}</p>
                        <div class="btn-group">
                            <button class="btn btn-reg" onclick="openReg('${evs[i][0]}')">æˆ‘è¦å ±å</button>
                            <button class="btn btn-info" onclick="openInfo('${evs[i][0]}','${evs[i][2]}')">å ±åç‹€æ³</button>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('list').innerHTML = html || "ç›®å‰æ²’æœ‰æ´»å‹•";
        } catch(e) { document.getElementById('list').innerHTML = "è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€ã€‚"; }
    }

    function openReg(name) {
        curEv = name;
        document.getElementById('regUI').style.display = "block";
        document.getElementById('regTitle').innerText = "å ±åï¼š" + name;
        document.getElementById('uName').value = localStorage.getItem('uName') || "";
    }

    async function openInfo(name, detail) {
        document.getElementById('infoUI').style.display = "block";
        document.getElementById('infoTitle').innerText = "ã€åå–®ã€‘" + name;
        document.getElementById('viewDetail').innerText = "ğŸ“Œ æ´»å‹•èªªæ˜ï¼š\n" + detail;
        
        const res = await fetch(API_URL + "?action=getRecords&t=" + Date.now());
        const recs = await res.json();
        let html = "<h4>å·²å ±ååå–®ï¼š</h4><ul>";
        let count = 0;
        for(let i=1; i<recs.length; i++){
            if(recs[i][1] === name) {
                count++;
                html += `<li>${recs[i][2]} (${recs[i][3]}äºº) - ${recs[i][4] || 'ç„¡å‚™è¨»'}</li>`;
            }
        }
        document.getElementById('viewStatus').innerHTML = html + `</ul><p><b>ç¸½è¨ˆï¼š${count} ç­†</b></p>`;
    }

    async function submitReg() {
        const name = document.getElementById('uName').value;
        if(!name) return alert("è«‹å¡«å¯«å§“å");
        localStorage.setItem('uName', name);
        const profile = await liff.getProfile();
        
        const payload = { action: "register", event: curEv, name: name, count: document.getElementById('uCount').value, note: document.getElementById('uNote').value, lineId: profile.userId };
        
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("å ±åæˆåŠŸï¼");
        location.reload();
    }

    init();
</script>
</body>
</html>
