<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å…¥å£</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; width: 48%; }
        .btn-reg { background: #00b900; }
        .btn-info { background: #3498db; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    </style>
</head>
<body>

<div id="mainUI">
    <h2 style="text-align:center;">ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
    <div id="list">è®€å–ä¸­...</div>
</div>

<div id="regUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="regTitle">å ±åæ´»å‹•</h2>
    <input type="text" id="uName" placeholder="æ‚¨çš„çœŸå¯¦å§“å" style="width:100%; padding:10px; margin:10px 0;">
    <input type="number" id="uCount" value="1" min="1" style="width:100%; padding:10px; margin:10px 0;">
    <textarea id="uNote" placeholder="å‚™è¨»/æ›²ç›®" style="width:100%; padding:10px; margin:10px 0;"></textarea>
    <button onclick="submitReg()" style="width:100%; padding:15px; background:#00b900; color:white; border:none; border-radius:8px;">ç¢ºèªé€å‡º</button>
</div>

<div id="infoUI" class="overlay">
    <button onclick="location.reload()">â† è¿”å›</button>
    <h2 id="infoTitle">å ±åé€²åº¦</h2>
    <p id="viewDetail" style="background:#eee; padding:10px; white-space:pre-wrap;"></p>
    <div id="viewStatus"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec";
    const LIFF_ID = "2008808495-Sbl6oi6u";
    let curEv = "";

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        
        const res = await fetch(API_URL + "?action=getEvents&t=" + Date.now());
        const evs = await res.json();
        let html = "";
        for(let i=1; i<evs.length; i++){
            if(evs[i][1] === "é€²è¡Œä¸­") {
                html += `<div class="card">
                    <div style="font-weight:bold; color:#00b900;">${evs[i][0]}</div>
                    <p style="font-size:14px; color:#666;">${evs[i][2] || 'ç„¡èªªæ˜'}</p>
                    <button class="btn btn-reg" onclick="openReg('${evs[i][0]}')">æˆ‘è¦å ±å</button>
                    <button class="btn btn-info" onclick="openInfo('${evs[i][0]}','${evs[i][2]}')">å ±åç‹€æ³</button>
                </div>`;
            }
        }
        document.getElementById('list').innerHTML = html || "ç›®å‰æ²’æœ‰æ´»å‹•";
    }

    function openReg(name) {
        curEv = name;
        document.getElementById('regUI').style.display = "block";
        document.getElementById('regTitle').innerText = name;
        document.getElementById('uName').value = localStorage.getItem('uName') || "";
    }

    async function openInfo(name, detail) {
        document.getElementById('infoUI').style.display = "block";
        document.getElementById('infoTitle').innerText = name;
        document.getElementById('viewDetail').innerText = detail || "ç„¡æ´»å‹•èªªæ˜";
        
        const res = await fetch(API_URL + "?action=getRecords&t=" + Date.now());
        const recs = await res.json();
        let html = "<h4>å·²å ±ååå–®ï¼š</h4><ul>";
        let count = 0;
        for(let i=1; i<recs.length; i++){
            if(String(recs[i][1]).trim() === name.trim()){
                count++;
                html += `<li>${recs[i][2]} (${recs[i][3]}äºº)</li>`;
            }
        }
        document.getElementById('viewStatus').innerHTML = html + `</ul><p><b>ç¸½è¨ˆï¼š${count} ç­†</b></p>`;
    }

    async function submitReg() {
        const name = document.getElementById('uName').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        localStorage.setItem('uName', name);
        const profile = await liff.getProfile();
        
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "register", event: curEv, name: name, 
                count: document.getElementById('uCount').value,
                note: document.getElementById('uNote').value,
                lineId: profile.userId
            })
        });
        alert("å ±åæˆåŠŸï¼");
        location.reload();
    }
    init();
</script>
</body>
</html>
