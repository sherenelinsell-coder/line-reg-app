<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åå…¥å£</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .ev-item { border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #fff; }
        .ev-title { font-size: 18px; font-weight: bold; color: #00b900; }
        .ev-detail { font-size: 14px; color: #666; margin: 10px 0; white-space: pre-wrap; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; }
        .btn-reg { background: #00b900; color: white; }
        .btn-info { background: #3498db; color: white; }
        .form-box { display: none; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="card" id="listUI">
    <h2 style="text-align:center;">ğŸ“… è¿‘æœŸæ´»å‹•åˆ—è¡¨</h2>
    <div id="activityList">è®€å–ä¸­...</div>
</div>

<div class="card form-box" id="regUI">
    <button onclick="location.reload()" style="background:none; border:none; color:#999; cursor:pointer;">â† è¿”å›åˆ—è¡¨</button>
    <h2 id="regTitle">å ±åæ´»å‹•</h2>
    <form id="regForm">
        <input type="text" id="userName" placeholder="å§“å" required>
        <input type="number" id="userCount" value="1" min="1" required>
        <textarea id="userNote" placeholder="å‚™è¨»/æ›²ç›®"></textarea>
        <button type="submit" class="btn btn-reg" style="width:100%;">ç¢ºèªæäº¤å ±å</button>
    </form>
</div>

<div class="card form-box" id="infoUI">
    <button onclick="location.reload()" style="background:none; border:none; color:#999; cursor:pointer;">â† è¿”å›åˆ—è¡¨</button>
    <h2 id="infoTitle">æ´»å‹•è©³æƒ…èˆ‡é€²åº¦</h2>
    <div id="infoContent" style="background:#f9f9f9; padding:15px; border-radius:8px;"></div>
    <div id="infoStatus" style="margin-top:20px;"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbza_e3Wc826Jl9TtYpOnwEmNYVhhlvtuD-5SxL0S5cjgT5pUCS3ZvIBSw0hPJFJBPsT/exec"; 
    const MY_LIFF_ID = "2008808495-Sbl6oi6u";
    let selectedEvent = "";

    async function init() {
        await liff.init({ liffId: MY_LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        const res = await fetch(API_URL + "?action=getEvents&t=" + Date.now());
        const evs = await res.json();
        let html = "";
        for(let i=1; i<evs.length; i++){
            if(evs[i][1] === "é€²è¡Œä¸­"){
                html += `<div class="ev-item">
                    <div class="ev-title">${evs[i][0]}</div>
                    <div class="ev-detail">${evs[i][2] || 'æš«ç„¡è©³æƒ…'}</div>
                    <div class="btn-group">
                        <button class="btn btn-reg" onclick="goReg('${evs[i][0]}')">æˆ‘è¦å ±å</button>
                        <button class="btn btn-info" onclick="goInfo('${evs[i][0]}','${evs[i][2] || 'ç„¡'}')">å ±åç‹€æ³</button>
                    </div>
                </div>`;
            }
        }
        document.getElementById('activityList').innerHTML = html || "ç›®å‰æ²’æœ‰æ´»å‹•å–”ï¼";
    }

    function goReg(name) {
        selectedEvent = name;
        document.getElementById('listUI').style.display = "none";
        document.getElementById('regUI').style.display = "block";
        document.getElementById('regTitle').innerText = "å ±åï¼š" + name;
        const saved = localStorage.getItem('user_real_name');
        if(saved) document.getElementById('userName').value = saved;
    }

    async function goInfo(name, detail) {
        document.getElementById('listUI').style.display = "none";
        document.getElementById('infoUI').style.display = "block";
        document.getElementById('infoTitle').innerText = name;
        document.getElementById('infoContent').innerText = "ğŸ“Œ æ´»å‹•èªªæ˜ï¼š\n" + detail;
        
        const res = await fetch(API_URL + "?action=getRecords&t=" + Date.now());
        const recs = await res.json();
        let html = "<h4>ç›®å‰å ±ååå–®ï¼š</h4>";
        let count = 0;
        for(let i=1; i<recs.length; i++){
            if(recs[i][1] === name){
                count++;
                html += `<div style="font-size:14px; border-bottom:1px solid #eee; padding:5px 0;">${count}. ${recs[i][2]} (${recs[i][3]}äºº) - ${recs[i][4] || 'ç„¡å‚™è¨»'}</div>`;
            }
        }
        document.getElementById('infoStatus').innerHTML = html + `<p><b>ç¸½è¨ˆï¼š${count} ç­†å ±å</b></p>`;
    }

    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        const name = document.getElementById('userName').value;
        localStorage.setItem('user_real_name', name);
        const profile = await liff.getProfile();
        const data = { action: "register", event: selectedEvent, name: name, count: document.getElementById('userCount').value, note: document.getElementById('userNote').value, lineId: profile.userId };
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        alert("å ±åæˆåŠŸï¼");
        location.reload();
    };

    init();
</script>
</body>
</html>
